version: '3.8'

services:
  # WireGuard VPN 服务
  wireguard:
    build:
      context: .
      dockerfile: Dockerfile.wireguard
    image: wireguard-manager:latest
    container_name: wireguard-vpn
    restart: unless-stopped

    # 网络模式 - 使用主机网络以便 VPN 正常工作
    network_mode: host

    # 特权模式 - WireGuard 需要
    privileged: true

    # 能力
    cap_add:
      - NET_ADMIN
      - SYS_MODULE

    # 环境变量
    environment:
      - WG_INTERFACE=wg0
      - WG_PORT=51820
      - SERVER_VPN_IP=10.8.0.1/24
      - TZ=Asia/Shanghai

    # 持久化存储
    volumes:
      - ./config/wireguard:/etc/wireguard
      - /lib/modules:/lib/modules:ro

    # 注意: 使用 host 网络模式时不能设置 sysctls
    # 需要在宿主机上手动启用 IP 转发:
    # echo 1 > /proc/sys/net/ipv4/ip_forward
    # echo 'net.ipv4.ip_forward=1' >> /etc/sysctl.conf

    # 日志配置
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Web 管理界面
  wireguard-web:
    build:
      context: .
      dockerfile: Dockerfile.web
    image: wireguard-web:latest
    container_name: wireguard-web-ui
    restart: unless-stopped

    # 端口映射
    ports:
      - "8080:8080"

    # 环境变量
    environment:
      - WEB_PORT=8080
      - TZ=Asia/Shanghai

    # 持久化存储 - 共享 WireGuard 配置
    volumes:
      - ./config/wireguard:/etc/wireguard

    # 依赖服务
    depends_on:
      - wireguard

    # 网络模式 - 需要访问宿主机网络以执行 wg 命令
    network_mode: host

    # 日志配置
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# 数据卷
volumes:
  wireguard-config:
    driver: local

# 网络（使用 host 模式时不需要自定义网络）
# networks:
#   wireguard-net:
#     driver: bridge
