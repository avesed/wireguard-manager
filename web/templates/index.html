<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>WireGuard ç®¡ç†é¢æ¿</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .header h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .header .subtitle {
            color: #666;
            font-size: 14px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .stat-card .label {
            color: #888;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }

        .stat-card .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            margin-top: 10px;
        }

        .status.online {
            background: #10b981;
            color: white;
        }

        .status.offline {
            background: #ef4444;
            color: white;
        }

        .main-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-header h2 {
            color: #333;
            font-size: 22px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .clients-table {
            width: 100%;
            border-collapse: collapse;
        }

        .clients-table th {
            background: #f9fafb;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
        }

        .clients-table td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            color: #6b7280;
        }

        .clients-table tr:hover {
            background: #f9fafb;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #333;
            font-size: 20px;
        }

        .close-btn {
            font-size: 28px;
            color: #999;
            cursor: pointer;
            line-height: 1;
        }

        .close-btn:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .config-box {
            background: #1f2937;
            color: #f3f4f6;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
            margin-bottom: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .qrcode-box {
            text-align: center;
            margin: 20px 0;
        }

        .qrcode-box img {
            max-width: 300px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
        }

        .config-button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .config-btn-half {
            flex: 1;
            min-width: 0;
        }

        @media (max-width: 480px) {
            .config-button-group {
                flex-direction: column;
            }

            .config-btn-half {
                width: 100%;
            }
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .refresh-btn {
            margin-left: 10px;
            background: #10b981;
        }

        .refresh-btn:hover {
            background: #059669;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>ğŸ”’ WireGuard ç®¡ç†é¢æ¿</h1>
                    <p class="subtitle">è½»æ¾ç®¡ç†æ‚¨çš„ VPN æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯</p>
                </div>
                <div>
                    <button class="btn btn-secondary" onclick="logout()" style="padding: 8px 16px;">
                        ğŸšª æ³¨é”€
                    </button>
                </div>
            </div>
        </div>

        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="label">æœåŠ¡å™¨çŠ¶æ€</div>
                <div class="value" id="serverStatus">
                    <span class="status offline">æ£€æŸ¥ä¸­...</span>
                </div>
                <div style="margin-top: 10px; font-size: 14px; color: #666;">
                    <div id="serverIP">IP: -</div>
                    <div id="serverPort">ç«¯å£: -</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="label">å®¢æˆ·ç«¯æ€»æ•°</div>
                <div class="value" id="totalClients">0</div>
            </div>

            <div class="stat-card">
                <div class="label">åœ¨çº¿å®¢æˆ·ç«¯</div>
                <div class="value" id="onlineClients">0</div>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="main-content">
            <div class="section-header">
                <h2>å®¢æˆ·ç«¯åˆ—è¡¨</h2>
                <div>
                    <button class="btn btn-primary refresh-btn" onclick="refreshData()">ğŸ”„ åˆ·æ–°</button>
                    <button class="btn btn-primary" onclick="showAddClientModal()">â• æ·»åŠ å®¢æˆ·ç«¯</button>
                </div>
            </div>

            <div id="clientsTableContainer">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ å®¢æˆ·ç«¯æ¨¡æ€æ¡† -->
    <div id="addClientModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ·»åŠ æ–°å®¢æˆ·ç«¯</h3>
                <span class="close-btn" onclick="closeAddClientModal()">&times;</span>
            </div>
            <form onsubmit="addClient(event)">
                <div class="form-group">
                    <label for="clientName">å®¢æˆ·ç«¯åç§°</label>
                    <input type="text" id="clientName" placeholder="ä¾‹å¦‚: laptop, phone, tablet" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">åˆ›å»ºå®¢æˆ·ç«¯</button>
            </form>
        </div>
    </div>

    <!-- æŸ¥çœ‹é…ç½®æ¨¡æ€æ¡† -->
    <div id="configModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>å®¢æˆ·ç«¯é…ç½®</h3>
                <span class="close-btn" onclick="closeConfigModal()">&times;</span>
            </div>
            <div id="configContent">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let refreshInterval;
        let currentRefreshDelay = 30000; // å½“å‰åˆ·æ–°é—´éš”ï¼ˆæ¯«ç§’ï¼‰
        let consecutiveErrors = 0; // è¿ç»­é”™è¯¯æ¬¡æ•°
        let isRateLimited = false; // æ˜¯å¦è¢«é™é€Ÿ
        let rateLimitRetryTime = null; // é™é€Ÿæ¢å¤æ—¶é—´

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            refreshData();
            // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°
            refreshInterval = setInterval(refreshData, currentRefreshDelay);
        });

        // é‡ç½®åˆ·æ–°é—´éš”
        function resetRefreshInterval(newDelay) {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            currentRefreshDelay = newDelay;
            refreshInterval = setInterval(refreshData, currentRefreshDelay);
        }

        // åˆ·æ–°æ•°æ®
        async function refreshData() {
            try {
                const response = await fetch('/api/status');

                // æ£€æŸ¥ HTTP 429 é€Ÿç‡é™åˆ¶é”™è¯¯
                if (response.status === 429) {
                    consecutiveErrors++;
                    isRateLimited = true;

                    // è®¡ç®—ä¸‹æ¬¡é‡è¯•æ—¶é—´ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
                    const retryDelay = Math.min(30000 * Math.pow(2, consecutiveErrors - 1), 120000);
                    rateLimitRetryTime = Date.now() + retryDelay;

                    console.warn(`é€Ÿç‡é™åˆ¶è§¦å‘ï¼Œ${retryDelay/1000}ç§’åé‡è¯•`);

                    // è°ƒæ•´åˆ·æ–°é—´éš”
                    if (currentRefreshDelay < retryDelay) {
                        resetRefreshInterval(retryDelay);
                    }

                    // æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æç¤º
                    showRateLimitError(retryDelay);
                    return;
                }

                // æ£€æŸ¥å…¶ä»– HTTP é”™è¯¯
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                // è¯·æ±‚æˆåŠŸï¼Œé‡ç½®é”™è¯¯è®¡æ•°å’Œé€Ÿç‡é™åˆ¶çŠ¶æ€
                consecutiveErrors = 0;
                isRateLimited = false;

                // å¦‚æœä¹‹å‰å› ä¸ºé”™è¯¯æé«˜äº†åˆ·æ–°é—´éš”ï¼Œç°åœ¨æ¢å¤æ­£å¸¸
                if (currentRefreshDelay !== 30000) {
                    resetRefreshInterval(30000);
                }

                // æ›´æ–°æœåŠ¡å™¨çŠ¶æ€
                updateServerStatus(data.server);

                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                document.getElementById('totalClients').textContent = data.client_count || 0;
                document.getElementById('onlineClients').textContent = data.online_count || 0;

                // æ›´æ–°å®¢æˆ·ç«¯è¡¨æ ¼
                updateClientsTable(data.clients || []);

                // æ¸…é™¤ä»»ä½•é”™è¯¯æç¤º
                clearErrorMessages();
            } catch (error) {
                consecutiveErrors++;
                console.error('åˆ·æ–°æ•°æ®å¤±è´¥:', error);

                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼Œä½†ä¿æŒä¹‹å‰çš„æ•°æ®å¯è§
                showNetworkError(error);

                // å¦‚æœè¿ç»­å¤±è´¥å¤šæ¬¡ï¼Œå¢åŠ é‡è¯•é—´éš”
                if (consecutiveErrors >= 3 && currentRefreshDelay < 60000) {
                    resetRefreshInterval(60000);
                }
            }
        }

        // æ˜¾ç¤ºé€Ÿç‡é™åˆ¶é”™è¯¯
        function showRateLimitError(retryDelay) {
            const container = document.getElementById('clientsTableContainer');
            const retrySeconds = Math.ceil(retryDelay / 1000);

            // å¦‚æœå·²æœ‰è¡¨æ ¼æ•°æ®ï¼Œä¿ç•™å®ƒï¼Œåªæ˜¾ç¤ºè­¦å‘Šæ¨ªå¹…
            const existingTable = container.querySelector('.clients-table');
            if (existingTable) {
                // ç§»é™¤æ—§çš„é”™è¯¯æ¨ªå¹…
                const oldBanner = container.querySelector('.error-banner');
                if (oldBanner) oldBanner.remove();

                // åœ¨è¡¨æ ¼å‰æ·»åŠ é”™è¯¯æ¨ªå¹…
                const banner = document.createElement('div');
                banner.className = 'error-banner rate-limit-banner';
                banner.innerHTML = `
                    <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 6px; padding: 12px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: #92400e;">âš ï¸ é€Ÿç‡é™åˆ¶</strong>
                            <p style="color: #78350f; margin: 5px 0 0 0; font-size: 13px;">è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œ${retrySeconds}ç§’åè‡ªåŠ¨é‡è¯•</p>
                        </div>
                        <button class="btn btn-secondary" onclick="forceRetry()" style="padding: 6px 12px; font-size: 12px;">ç«‹å³é‡è¯•</button>
                    </div>
                `;
                container.insertBefore(banner, container.firstChild);
            } else {
                // æ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºå®Œæ•´é”™è¯¯é¡µé¢
                container.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 48px;">â±ï¸</div>
                        <p style="color: #f59e0b;"><strong>é€Ÿç‡é™åˆ¶</strong></p>
                        <p style="font-size: 14px; margin: 10px 0;">è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œ${retrySeconds}ç§’åè‡ªåŠ¨é‡è¯•</p>
                        <button class="btn btn-primary" onclick="forceRetry()" style="margin-top: 10px;">ç«‹å³é‡è¯•</button>
                    </div>
                `;
            }
        }

        // æ˜¾ç¤ºç½‘ç»œé”™è¯¯
        function showNetworkError(error) {
            const container = document.getElementById('clientsTableContainer');
            const existingTable = container.querySelector('.clients-table');

            if (existingTable) {
                // ç§»é™¤æ—§çš„é”™è¯¯æ¨ªå¹…
                const oldBanner = container.querySelector('.error-banner');
                if (oldBanner) oldBanner.remove();

                // åœ¨è¡¨æ ¼å‰æ·»åŠ é”™è¯¯æ¨ªå¹…
                const banner = document.createElement('div');
                banner.className = 'error-banner network-error-banner';
                banner.innerHTML = `
                    <div style="background: #fee2e2; border: 1px solid #ef4444; border-radius: 6px; padding: 12px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: #991b1b;">âš ï¸ è¿æ¥å¤±è´¥</strong>
                            <p style="color: #7f1d1d; margin: 5px 0 0 0; font-size: 13px;">æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œå°†è‡ªåŠ¨é‡è¯•</p>
                        </div>
                        <button class="btn btn-secondary" onclick="forceRetry()" style="padding: 6px 12px; font-size: 12px;">ç«‹å³é‡è¯•</button>
                    </div>
                `;
                container.insertBefore(banner, container.firstChild);
            } else {
                // æ²¡æœ‰æ•°æ®æ—¶æ‰æ˜¾ç¤ºå®Œæ•´é”™è¯¯é¡µé¢
                container.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 48px;">âš ï¸</div>
                        <p style="color: #ef4444;"><strong>è¿æ¥å¤±è´¥</strong></p>
                        <p style="font-size: 14px; margin: 10px 0;">æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</p>
                        <button class="btn btn-primary" onclick="forceRetry()" style="margin-top: 10px;">ç«‹å³é‡è¯•</button>
                    </div>
                `;
            }
        }

        // æ¸…é™¤é”™è¯¯æ¶ˆæ¯
        function clearErrorMessages() {
            const banner = document.querySelector('.error-banner');
            if (banner) {
                banner.remove();
            }
        }

        // å¼ºåˆ¶é‡è¯•
        function forceRetry() {
            consecutiveErrors = 0;
            isRateLimited = false;
            resetRefreshInterval(30000);
            clearErrorMessages();
            refreshData();
        }

        // æ›´æ–°æœåŠ¡å™¨çŠ¶æ€
        function updateServerStatus(server) {
            const statusEl = document.getElementById('serverStatus');
            const ipEl = document.getElementById('serverIP');
            const portEl = document.getElementById('serverPort');

            if (server.status === 'active') {
                statusEl.innerHTML = '<span class="status online">è¿è¡Œä¸­</span>';
            } else {
                statusEl.innerHTML = '<span class="status offline">å·²åœæ­¢</span>';
            }

            ipEl.textContent = `IP: ${server.public_ip || 'N/A'}`;
            portEl.textContent = `ç«¯å£: ${server.listen_port || 'N/A'}`;
        }

        // æ›´æ–°å®¢æˆ·ç«¯è¡¨æ ¼
        function updateClientsTable(clients) {
            const container = document.getElementById('clientsTableContainer');

            if (clients.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 48px;">ğŸ“­</div>
                        <p>è¿˜æ²¡æœ‰å®¢æˆ·ç«¯</p>
                        <p style="font-size: 12px;">ç‚¹å‡»"æ·»åŠ å®¢æˆ·ç«¯"æŒ‰é’®åˆ›å»ºç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯</p>
                    </div>
                `;
                return;
            }

            let html = `
                <table class="clients-table">
                    <thead>
                        <tr>
                            <th>åç§°</th>
                            <th>IP åœ°å€</th>
                            <th>çŠ¶æ€</th>
                            <th>æœ€åæ¡æ‰‹</th>
                            <th>å·²ä½¿ç”¨æµé‡</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            clients.forEach(client => {
                const statusBadge = client.status === 'online'
                    ? '<span class="badge badge-success">åœ¨çº¿</span>'
                    : '<span class="badge badge-danger">ç¦»çº¿</span>';

                html += `
                    <tr>
                        <td><strong>${escapeHtml(client.name)}</strong></td>
                        <td>${escapeHtml(client.ip)}</td>
                        <td>${statusBadge}</td>
                        <td>${escapeHtml(client.last_handshake)}</td>
                        <td>${escapeHtml(client.transfer_total || '0 B')}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-secondary" onclick="showConfig('${escapeHtml(client.name)}')">æŸ¥çœ‹</button>
                                <button class="btn btn-danger" onclick="deleteClient('${escapeHtml(client.name)}')">åˆ é™¤</button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        // æ˜¾ç¤ºæ·»åŠ å®¢æˆ·ç«¯æ¨¡æ€æ¡†
        function showAddClientModal() {
            document.getElementById('addClientModal').classList.add('active');
            document.getElementById('clientName').value = '';
        }

        // å…³é—­æ·»åŠ å®¢æˆ·ç«¯æ¨¡æ€æ¡†
        function closeAddClientModal() {
            document.getElementById('addClientModal').classList.remove('active');
        }

        // æ·»åŠ å®¢æˆ·ç«¯
        async function addClient(event) {
            event.preventDefault();

            const clientName = document.getElementById('clientName').value.trim();
            if (!clientName) return;

            try {
                // å®‰å…¨è·å– CSRF token
                const csrfMeta = document.querySelector('meta[name="csrf-token"]');
                if (!csrfMeta) {
                    throw new Error('ä¼šè¯å·²è¿‡æœŸï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                }
                const csrfToken = csrfMeta.getAttribute('content');

                const response = await fetch('/api/client/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ name: clientName })
                });

                // æ£€æŸ¥ HTTP çŠ¶æ€
                if (response.status === 429) {
                    alert('âŒ è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•');
                    return;
                }

                const data = await response.json();

                if (data.success) {
                    alert(`âœ… å®¢æˆ·ç«¯ "${clientName}" åˆ›å»ºæˆåŠŸï¼`);
                    closeAddClientModal();
                    refreshData();
                    // è‡ªåŠ¨æ˜¾ç¤ºé…ç½®
                    setTimeout(() => showConfig(clientName), 500);
                } else {
                    alert(`âŒ åˆ›å»ºå¤±è´¥: ${data.error}`);
                }
            } catch (error) {
                alert(`âŒ åˆ›å»ºå¤±è´¥: ${error.message}`);
            }
        }

        // æ˜¾ç¤ºå®¢æˆ·ç«¯é…ç½®
        async function showConfig(clientName) {
            const modal = document.getElementById('configModal');
            const content = document.getElementById('configContent');

            modal.classList.add('active');
            content.innerHTML = '<div class="loading">åŠ è½½é…ç½®ä¸­...</div>';

            try {
                const response = await fetch(`/api/client/${encodeURIComponent(clientName)}/config`);
                const data = await response.json();

                if (data.success) {
                    let html = `
                        <h4 style="margin-bottom: 15px;">é…ç½®æ–‡ä»¶</h4>
                        <div class="config-box">${escapeHtml(data.config)}</div>
                        <div class="config-button-group">
                            <button class="btn btn-primary config-btn-half" onclick="copyConfig(this)">ğŸ“‹ å¤åˆ¶é…ç½®</button>
                            <button class="btn btn-primary config-btn-half" onclick="downloadConfig('${escapeHtml(clientName)}', this)">ğŸ’¾ ä¸‹è½½é…ç½®æ–‡ä»¶</button>
                        </div>
                    `;

                    if (data.qrcode) {
                        html += `
                            <h4 style="margin: 20px 0 15px 0;">æ‰«æäºŒç»´ç ï¼ˆæ‰‹æœºç«¯ï¼‰</h4>
                            <div class="qrcode-box">
                                <img src="data:image/png;base64,${data.qrcode}" alt="QR Code">
                            </div>
                        `;
                    }

                    content.innerHTML = html;
                } else {
                    content.innerHTML = `<div class="empty-state">âŒ åŠ è½½é…ç½®å¤±è´¥: ${data.error}</div>`;
                }
            } catch (error) {
                content.innerHTML = `<div class="empty-state">âŒ åŠ è½½é…ç½®å¤±è´¥: ${error.message}</div>`;
            }
        }

        // å…³é—­é…ç½®æ¨¡æ€æ¡†
        function closeConfigModal() {
            document.getElementById('configModal').classList.remove('active');
        }

        // å¤åˆ¶é…ç½®ï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œfallbackï¼‰
        function copyConfig(button) {
            const originalText = button.textContent;

            // å®‰å…¨è·å–é…ç½®æ–‡æœ¬
            const configBox = document.querySelector('.config-box');
            if (!configBox) {
                button.textContent = 'âŒ é”™è¯¯';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
                alert('æ— æ³•æ‰¾åˆ°é…ç½®å†…å®¹ï¼Œè¯·é‡æ–°æ‰“å¼€é…ç½®çª—å£');
                return;
            }
            const configText = configBox.textContent;

            // å°è¯•ä½¿ç”¨ç°ä»£ Clipboard API
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(configText)
                    .then(() => {
                        button.textContent = 'âœ… å·²å¤åˆ¶ï¼';
                        setTimeout(() => {
                            button.textContent = originalText;
                        }, 2000);
                    })
                    .catch(err => {
                        console.error('Clipboard API å¤±è´¥:', err);
                        // å¤±è´¥æ—¶å°è¯•fallbackæ–¹æ³•
                        fallbackCopyText(configText, button, originalText);
                    });
            } else {
                // ä¸æ”¯æŒClipboard APIï¼Œä½¿ç”¨fallbackæ–¹æ³•
                fallbackCopyText(configText, button, originalText);
            }
        }

        // Fallback å¤åˆ¶æ–¹æ³•ï¼ˆé€‚ç”¨äºHTTPæˆ–ä¸æ”¯æŒClipboard APIçš„æµè§ˆå™¨ï¼‰
        function fallbackCopyText(text, button, originalText) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-9999px';
            textArea.style.top = '0';
            document.body.appendChild(textArea);

            try {
                textArea.focus();
                textArea.select();
                const successful = document.execCommand('copy');

                if (successful) {
                    button.textContent = 'âœ… å·²å¤åˆ¶ï¼';
                    setTimeout(() => {
                        button.textContent = originalText;
                    }, 2000);
                } else {
                    button.textContent = 'âŒ å¤åˆ¶å¤±è´¥';
                    setTimeout(() => {
                        button.textContent = originalText;
                    }, 2000);
                    alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¹¶å¤åˆ¶é…ç½®æ–‡æœ¬');
                }
            } catch (err) {
                console.error('Fallbackå¤åˆ¶å¤±è´¥:', err);
                button.textContent = 'âŒ å¤åˆ¶å¤±è´¥';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¹¶å¤åˆ¶é…ç½®æ–‡æœ¬');
            } finally {
                document.body.removeChild(textArea);
            }
        }

        // ä¸‹è½½é…ç½®æ–‡ä»¶
        function downloadConfig(clientName, button) {
            const originalText = button.textContent;

            // å®‰å…¨è·å–é…ç½®æ–‡æœ¬
            const configBox = document.querySelector('.config-box');
            if (!configBox) {
                button.textContent = 'âŒ é”™è¯¯';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
                alert('æ— æ³•æ‰¾åˆ°é…ç½®å†…å®¹ï¼Œè¯·é‡æ–°æ‰“å¼€é…ç½®çª—å£');
                return;
            }
            const configText = configBox.textContent;

            try {
                // åˆ›å»ºBlobå¯¹è±¡
                const blob = new Blob([configText], { type: 'text/plain;charset=utf-8' });

                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${clientName}.conf`;

                // è§¦å‘ä¸‹è½½
                document.body.appendChild(link);
                link.click();

                // æ¸…ç†
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);

                // ç”¨æˆ·åé¦ˆ
                button.textContent = 'âœ… å·²ä¸‹è½½ï¼';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            } catch (err) {
                console.error('ä¸‹è½½å¤±è´¥:', err);
                button.textContent = 'âŒ ä¸‹è½½å¤±è´¥';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
                alert('ä¸‹è½½å¤±è´¥: ' + err.message);
            }
        }

        // åˆ é™¤å®¢æˆ·ç«¯
        async function deleteClient(clientName) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤å®¢æˆ·ç«¯ "${clientName}" å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }

            try {
                // å®‰å…¨è·å– CSRF token
                const csrfMeta = document.querySelector('meta[name="csrf-token"]');
                if (!csrfMeta) {
                    throw new Error('ä¼šè¯å·²è¿‡æœŸï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                }
                const csrfToken = csrfMeta.getAttribute('content');

                const response = await fetch(`/api/client/${encodeURIComponent(clientName)}/delete`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                });

                // æ£€æŸ¥ HTTP çŠ¶æ€
                if (response.status === 429) {
                    alert('âŒ è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•');
                    return;
                }

                const data = await response.json();

                if (data.success) {
                    alert(`âœ… å®¢æˆ·ç«¯ "${clientName}" å·²åˆ é™¤`);
                    refreshData();
                } else {
                    alert(`âŒ åˆ é™¤å¤±è´¥: ${data.error}`);
                }
            } catch (error) {
                alert(`âŒ åˆ é™¤å¤±è´¥: ${error.message}`);
            }
        }

        // HTML è½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // æ³¨é”€
        function logout() {
            if (confirm('ç¡®å®šè¦æ³¨é”€å—ï¼Ÿ')) {
                window.location.href = '/logout';
            }
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }
    </script>
</body>
</html>
